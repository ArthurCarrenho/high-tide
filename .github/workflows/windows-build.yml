name: Windows Build

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      debug_only:
        description: "Build debug versions only"
        required: false
        default: false
        type: boolean

env:
  APP_NAME: HighTide
  APP_VERSION: "1.1.0"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') }}

jobs:
  # ===========================================
  # Job 1: Build - Compile and prepare assets
  # ===========================================
  build:
    runs-on: windows-latest
    outputs:
      artifact_version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine artifact version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.ref }}" -match "^refs/tags/v(.+)$") {
            $version = $Matches[1]
            Write-Host "Tag detected, using version: $version"
          } else {
            $version = "${{ github.sha }}".Substring(0, 7)
            Write-Host "Commit detected, using short SHA: $version"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          cache: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-cmake
            base-devel
            mingw-w64-x86_64-gtk4
            mingw-w64-x86_64-libadwaita
            mingw-w64-x86_64-python
            mingw-w64-x86_64-python-pip
            mingw-w64-x86_64-python-gobject
            mingw-w64-x86_64-python-cairo
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-python-requests
            mingw-w64-x86_64-python-pillow
            mingw-w64-x86_64-python-dateutil
            mingw-w64-x86_64-python-certifi
            mingw-w64-x86_64-python-six
            mingw-w64-x86_64-python-winsdk
            mingw-w64-x86_64-python-cffi
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-blueprint-compiler
            mingw-w64-x86_64-gettext-tools
            git

      - name: Install Python packages
        shell: msys2 {0}
        run: |
          pip install cairosvg --break-system-packages

      - name: Build with Meson
        shell: msys2 {0}
        run: |
          meson setup builddir
          meson compile -C builddir

      - name: Compile GSettings schemas
        shell: msys2 {0}
        run: |
          glib-compile-schemas data/

      - name: Compile locale files
        shell: msys2 {0}
        run: |
          mkdir -p locale
          echo "Starting locale compilation..."
          while IFS= read -r lang || [ -n "$lang" ]; do
            [[ -z "$lang" || "$lang" =~ ^[[:space:]]*# ]] && continue
            lang=$(echo "$lang" | xargs)
            mkdir -p "locale/$lang/LC_MESSAGES"
            if [ -f "po/$lang.po" ]; then
              msgfmt -o "locale/$lang/LC_MESSAGES/high-tide.mo" "po/$lang.po"
              echo "✓ Compiled: $lang"
            else
              echo "✗ Missing: po/$lang.po"
            fi
          done < po/LINGUAS
          echo "Locale compilation complete."

      - name: Create Windows icon
        shell: msys2 {0}
        run: |
          python -c "
          from PIL import Image
          import cairosvg
          import os

          svg_path = 'data/icons/io.github.nokse22.high-tide.Source.svg'
          ico_dir = 'data/icons/hicolor/256x256/apps'
          png_path = os.path.join(ico_dir, 'io.github.nokse22.high-tide.png')
          ico_path = os.path.join(ico_dir, 'io.github.nokse22.high-tide.ico')

          os.makedirs(ico_dir, exist_ok=True)

          if not os.path.exists(png_path):
              print(f'Converting SVG to PNG: {svg_path} -> {png_path}')
              cairosvg.svg2png(url=svg_path, write_to=png_path, output_width=256, output_height=256)

          if os.path.exists(png_path):
              print(f'Converting PNG to ICO: {png_path} -> {ico_path}')
              img = Image.open(png_path)
              img.save(ico_path, format='ICO', sizes=[(256,256),(128,128),(64,64),(48,48),(32,32),(16,16)])
              print(f'Successfully created icon: {ico_path}')
          else:
              print(f'ERROR: PNG file not found: {png_path}')
              exit(1)
          "

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-intermediate
          path: |
            src/
            data/
            locale/
            windows/
            builddir/
            po/
            meson.build
            meson_options.txt
            COPYING
          retention-days: 1
          if-no-files-found: error

  # ===========================================
  # Job 2: Package - Create release/debug builds
  # ===========================================
  package:
    needs: build
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - build_type: release
            console: "False"
            suffix: ""
          - build_type: debug
            console: "True"
            suffix: "-debug"

    env:
      ARTIFACT_VERSION: ${{ needs.build.outputs.artifact_version }}

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-intermediate
          path: .

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          cache: true
          install: >-
            mingw-w64-x86_64-python
            mingw-w64-x86_64-python-pip
            mingw-w64-x86_64-python-gobject
            mingw-w64-x86_64-python-cairo
            mingw-w64-x86_64-python-pillow
            mingw-w64-x86_64-python-requests
            mingw-w64-x86_64-python-dateutil
            mingw-w64-x86_64-python-certifi
            mingw-w64-x86_64-python-six
            mingw-w64-x86_64-python-winsdk
            mingw-w64-x86_64-python-cffi
            mingw-w64-x86_64-gtk4
            mingw-w64-x86_64-libadwaita
            mingw-w64-x86_64-gstreamer
            mingw-w64-x86_64-gst-plugins-base
            mingw-w64-x86_64-gst-plugins-good
            mingw-w64-x86_64-gst-plugins-bad
            mingw-w64-x86_64-gst-plugins-ugly
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-libsecret
            mingw-w64-x86_64-pyinstaller

      - name: Install Python packages
        shell: msys2 {0}
        run: |
          pip install tidalapi pypresence pystray pillow winsdk

      - name: Update PyInstaller spec for ${{ matrix.build_type }}
        shell: msys2 {0}
        run: |
          sed -i 's/console=True/console=${{ matrix.console }}/g' windows/high-tide.spec
          sed -i 's/console=False/console=${{ matrix.console }}/g' windows/high-tide.spec

      - name: Build with PyInstaller
        shell: msys2 {0}
        run: |
          cd windows
          pyinstaller --noconfirm high-tide.spec

          # Copy GStreamer plugins
          echo "Copying GStreamer plugins..."
          mkdir -p dist/HighTide/gst_plugins
          GST_PLUGINS=(
            coreelements audioconvert audioresample playback autodetect
            directsound wasapi wasapi2 typefindfunctions audioparsers
            mpg123 flac ogg vorbis opus dash soup adaptivedemux2
            isomp4 gio volume app
          )
          for plugin in "${GST_PLUGINS[@]}"; do
            cp -f "/mingw64/lib/gstreamer-1.0/libgst${plugin}.dll" dist/HighTide/gst_plugins/ 2>/dev/null || true
          done

          # Copy Adwaita icons
          echo "Copying Adwaita icons..."
          mkdir -p dist/HighTide/share/icons
          cp -r /mingw64/share/icons/Adwaita dist/HighTide/share/icons/ || true

      - name: Move dist to project root
        shell: pwsh
        run: |
          if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
          Move-Item -Path "windows/dist" -Destination "dist"

      - name: Upload Portable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}-Windows-Portable${{ matrix.suffix }}
          path: dist/HighTide
          if-no-files-found: error

      - name: Install Inno Setup
        if: matrix.build_type == 'release' || github.event.inputs.debug_only != 'true'
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Build Installer
        if: matrix.build_type == 'release' || github.event.inputs.debug_only != 'true'
        shell: pwsh
        run: |
          $issContent = Get-Content "windows/installer.iss" -Raw
          $issContent = $issContent -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ env.APP_VERSION }}"'

          if ("${{ matrix.suffix }}" -ne "") {
            $issContent = $issContent -replace 'OutputBaseFilename=HighTide-\{#MyAppVersion\}-Setup', 'OutputBaseFilename=HighTide-{#MyAppVersion}-Setup${{ matrix.suffix }}'
          }

          Set-Content "windows/installer.iss" -Value $issContent
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "windows\installer.iss"

      - name: Upload Installer
        if: matrix.build_type == 'release' || github.event.inputs.debug_only != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ env.ARTIFACT_VERSION }}-Installer${{ matrix.suffix }}
          path: dist/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-Setup${{ matrix.suffix }}.exe
          if-no-files-found: warn

  # ===========================================
  # Job 3: Release - Create GitHub release
  # ===========================================
  release:
    needs: package
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Remove intermediate build artifact
        run: rm -rf artifacts/build-intermediate

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.zip
            artifacts/**/*.exe
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
